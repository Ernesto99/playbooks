---
- name: Configure ceilometer-agent-compute server
  hosts: nova-compute
  sudo: True
  gather_facts: True
  tags:
    - openstack
    - openstack-ceilometer-nova
  vars:
    component: ceilometer
    subcomponent: agent-compute
    packages:
      - "{{ component }}-{{ subcomponent }}"
    services:
      - "{{ component }}-{{ subcomponent }}"
    config_files:
      - "{{ component }}.conf"
    utopic_pkgs:
      - python-posix-ipc_0.9.8-2_amd64.deb
      - python-ceilometer_2014.2+git201406182101~trusty-0ubuntu1_all.deb

  tasks:

    - name: ensure {{ component }}-{{ subcomponent }} packages are installed
      apt: 
        pkg: "{{ item }}"
        state: latest 
        update_cache: yes 
        cache_valid_time: 600
      with_items: packages

    - name: ensure services are stopped
      service: 
        name: "{{ item }}"
        state: stopped
      with_items: services

    - name: ensure {{ component }} sqlite is deleted
      file: 
        dest: /var/lib/{{ component }}/{{ component }}.sqlite 
        state: absent

    - name: update configuration files from templates
      template: 
        src: templates/etc/{{ component }}/{{ item }}
        dest: /etc/{{ component }}/{{ item }}
        owner: "{{ component }}"
        group: "{{ component }}"
        mode: 0640
      with_items: config_files

    - name: ensure services are started and enabled
      service: 
        name: "{{ item }}"
        state: started
        enabled: yes
      with_items: services

#    - name: copy ceilometer-python packages of utopic (for getting the instance status field)
#      copy:
#        dest: "/tmp/{{ item }}"
#        src: "files/packages/{{ item }}"
#        owner: root
#        group: root
#        mode: 0644
#      with_items: utopic_pkgs

#    - name: install ceilometer-python packages of utopic
#      command: "dpkg -i /tmp/{{ item }}"
#      with_items: utopic_pkgs

#    - name: delete tmp files
#      file:
#        dest: "/tmp/{{ item }}"
#        state: absent
#      with_items: utopic_pkgs

#    - name: restart and enable ceilometer-agent-compute
#      service:
#        name: ceilometer-agent-compute
#        state: restarted
#        enabled: yes
